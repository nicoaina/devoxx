


	function ouvrirOngletDejaCree(boitier) {
		$('#onglets li').each(function(rang) {
			if (this.id == "onglet_" + boitier.mid) {
				$("#onglet_" + boitier.mid).addClass('actif').siblings().removeClass('actif'); // ligne a ajouter/enlever selon si on veut que le nouvel onglet céé prenne le focus ou non
				setDisplayBis(); // sinon le texte du contenu de l'onglet s'affiche à la fois dans le contenu du nouvel onglet et dans l'onglet tableau de bord
			}
		});
	}
	
	function ongletDejaCree(boitier) {
		var ongletExistant = false;
		$('#onglets li').each(function(rang) {
			if (this.id == "onglet_" + boitier.mid) {
				ongletExistant = true;
			}
		});
		return ongletExistant;
	}

	/**
	 * 
	 * @param bea
	 * @param mode = "ro" ou "visu" ou  "pec" (ro = read only : un "visu peut se tansformer en pec mais un "ro" reste "ro")
	 */	
	function ouvrirNouvelOnglet(bea, mode) {
		
		if (ongletDejaCree(bea)) {
			ouvrirOngletDejaCree(bea);
			return;
		}
		
		var image = $("<img/>",{
			src:bea.picto,
			style:"vertical-align:middle; margin-right:5px; margin-bottom:2px;"
		});		



		var onglet;
		
		if( mode == "ro") {
			onglet = $("<li/>",{
				id : "onglet_" + bea.mid,
				html:bea.nom,
				style : "padding-left:5px"
			});
		} else {
			onglet = $("<li/>",{
				id : "onglet_" + bea.mid,
				html:bea.nom,
				class : "ongletDegrade" + bea.alerteLaPlusGrave.severite.cssClass,
				style : "padding-left:5px"
			});
		}
		
		/***/		
		var spanCroix = $("<span/>",{
			html : "X",
			style: "border:solid; border-width:thin; margin-left:15px; padding:0px 1px 0 px 1px",
			click:function(){
				var fermeOnglet = false;
				if (mode == "pec") {
					fermeOnglet = confirm("Arreter la prise en compte du boitier ?");
				} else {
					fermeOnglet = true;
				}
				if (fermeOnglet) {
					supprimeOnglet(bea);
					supprimeContenuOnglet(bea);
					if (mode == "pec") {
						supprimeElementDansListeBoitierPEC(bea.mid);
						ajouterElementDansListeBoitierEnAlerte(bea, new Alerte(bea.nomAlerte), new Severite(bea.severite, bea.severiteCssClass));						
					}
				}
			}

		});
		spanCroix.css('cursor','pointer');
		onglet.prepend(image);
		onglet.append(spanCroix);		
		$("#onglets").append(onglet);

		fillContenuOnglet(bea, mode);
		$("#onglet_" + bea.mid).addClass('actif').siblings().removeClass('actif'); // ligne a ajouter/enlever selon si on veut que le nouvel onglet céé prenne le focus ou non
		setDisplayBis(); // sinon le texte du contenu de l'onglet s'affiche à la fois dans le contenu du nouvel onglet et dans l'onglet tableau de bord
	}
	
	/**
	 * 
	 * @param bea
	 * @param mode
	 */
	function fillContenuOnglet(bea, mode) {
		
		var divContenuOnglet = $("<div/>",{
			id:"contenu_onglet_" + bea.mid,
			class:"item"
		});
		var divHaut = getContenuOngletHaut(bea, mode);
		
		var imgCarte = $("<img/>",{
			src:"./img/carte.png",
			// class:"detailBoitier",
			style: "padding:2px; vertical-align:top"
		});		

		
		var divBas = $("<div/>");
		var table = $("<table/>",{
			style:"width:100%"
		});
		var row = $("<tr/>");
		var leftCol = $("<td/>",{
			class:"contourArrondi",
			style:"vertical-align: top;"
		});
		var rightCol = $("<td/>",{
			class:"contourArrondi"
		});
	
		var divListe = $("<div/>",{
			id:"liste_alertes_bea_" + bea.mid,
			class:"listeAlertes"
		});
		
		
		divContenuOnglet.append(divHaut, divBas);
		divBas.append(table);
		table.append(row);
		row.append(leftCol, rightCol);
		leftCol.append(divListe);
		rightCol.append(imgCarte);
		
		var listeAlertes = bea.alerteListe;
		for (var i = 0; i < listeAlertes.length; i++) {
			var divCellule = $("<div/>",{
				class:"alerte" + bea.alerteListe[i].severite.cssClass
			});

//			var image = $("<img/>",{
//				src:bea.picto,
//				style:"vertical-align:middle"
//			});		

			var labelNomAlerte = listeAlertes[i].nom + " (" + listeAlertes[i].type.type + ")";
			var spanAlerteType = $("<span/>",{
				html:labelNomAlerte,
				class:"typeAlerte" + listeAlertes[i].severite.cssClass
			});					
			divCellule.append(spanAlerteType);
			divListe.append(divCellule);
		}

		/*	
		*/
		$("#contenu").append(divContenuOnglet);		
	}
	
	/**
	 * 
	 * @param bea
	 * @param mode
	 */
	function getContenuOngletHaut(bea, mode) {
		
		var divHaut = $("<div/>",{
			class:"detailBoitier"
		});
	
		var spanTexte = $("<span/>");
		var spanAction = $("<div/>");

		var spanTextePEC = $("<span/>",{
			id:"texte_" + bea.mid,
			class:"boitierSansAlerte",
			html : "Bo&icirc;tier " + bea.nom + " pris en compte."
		});
		
		var spanActionPEC = $("<span/>",{
			id:"cloturer_" + bea.mid,
			class:"boitierSansAlerte",
			html : "Cl&ocirc;turer",
			style:"border:1px solid; width:100px; text-align:center;",
			click:function(){
				if (confirm("Cloturer le boitier en alerte ?")) {
					supprimeOnglet(bea);
					supprimeContenuOnglet(bea);
					supprimeElementDansListeBoitierPEC(bea.mid);
				} 
			}
		});	
		spanActionPEC.css('cursor','pointer');
		
		var	spanTexteVisu = $("<span/>",{
			id:"texte_" + bea.mid,
			class:"boitierSansAlerte",
			html : "Consultation Bo&icirc;tier " + bea.nom
		});
		
		var spanActionVisu = $("<span/>",{
			id:"pec_" + bea.mid,
			class:"boitierSansAlerte",
			html : "Prendre en compte",
			style:"border:1px solid; width:150px; text-align:center;",
			click:function(){
				$(this).replaceWith(spanActionPEC);
				$("#texte_" + bea.mid).replaceWith(spanTextePEC);
				supprimeElementDansListeBoitierEnAlerte(bea.mid);
				ajouterElementDansListeAlertePEC(bea);
			}
		});
		spanActionVisu.css('cursor','pointer');
		
		var	spanTexteReadOnly = $("<span/>",{
			class:"boitierSansAlerte",
			html : "Consultation d'un Bo&icirc;tier sans alerte " + bea.nom
		});

		var spanActionReadOnly = $("<span/>",{
			class:"boitierSansAlerte",
			html : "Fermer et retourner &agrave; la page principale",
			style:"border:1px solid; width:300px; text-align:center;",
			click:function(){
				supprimeOnglet(bea);
				supprimeContenuOnglet(bea);
			}
		});	
		spanActionReadOnly.css('cursor','pointer');

		if (mode == "pec") {
			spanTexte = spanTextePEC;
			spanAction = spanActionPEC;
		} else if (mode == "visu") {
			spanTexte = spanTexteVisu;
			spanAction = spanActionVisu;
		} else if (mode == "ro") {
			spanTexte = spanTexteReadOnly;
			spanAction = spanActionReadOnly;
		}

		divHaut.append(spanTexte, spanAction);
		return divHaut;

	}
	
	/**
	 * 
	 * @param bea
	 */
	function supprimeOnglet(bea) {
		$("#onglet_" + bea.mid).remove();
		$("#onglet_tdb").addClass('actif').siblings().removeClass('actif');
		setDisplayBis();
	}
	
	/**
	 * Copie de la fonction setDisplay définie dans index.html
	 */
	function setDisplayBis() {
		var modeAffichage;
		$('#onglets li').each(function(rang) {
			modeAffichage = $(this).hasClass('actif') ? '' : 'none';
			$('.item').eq(rang).css('display', modeAffichage);
		});
	}
	
	/**
	 * 
	 * @param bea
	 */
	function supprimeContenuOnglet(bea) {
		$("#contenu_onglet_" + bea.mid).remove();
	}

	function clignotement_onglet_locsight() {
		var x = 150;
		for (var i = 0; i < 3; i++) {
			
			$("#nbBEA_onglet").fadeTo(x, 0).delay(100).fadeTo(x, 1); 
		}
	}
	
	function refreshFond_onglet_locsight() {
		var bea = listeBoitierEnAlerte[0];
		
		//alert('refreshNB_BEA bea.mom=' + bea.nom);
		$("#onglet_tdb").removeClass("ongletDegradeRouge");
		$("#onglet_tdb").removeClass("ongletDegradeOrange");
		$("#onglet_tdb").removeClass("ongletDegradeJaune");
		
		if (bea != null) {
			//alert('refreshFond_onglet_locsight alerteLaPlusGrave=' + bea.alerteLaPlusGrave.severite.cssClass);
			$("#onglet_tdb").addClass("ongletDegrade" + bea.alerteLaPlusGrave.severite.cssClass);
		}		
	}