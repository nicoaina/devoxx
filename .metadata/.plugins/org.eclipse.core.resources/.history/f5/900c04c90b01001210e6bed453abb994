package com.deveryware.locsight.client;

import java.util.LinkedList;
import java.util.List;

import com.google.gwt.core.client.EntryPoint;
import com.google.gwt.user.cellview.client.CellTable;
import com.google.gwt.user.client.ui.FlexTable;
import com.google.gwt.user.client.ui.HTML;
import com.google.gwt.user.client.ui.Image;
import com.google.gwt.user.client.ui.RootPanel;
import com.google.gwt.user.client.ui.ScrollPanel;
import com.google.gwt.user.client.ui.TabPanel;

/**
 * Entry point classes define <code>onModuleLoad()</code>.
 */
public class Locsight implements EntryPoint {
	
	static List<BoitierRaw> boitierRaws = new LinkedList<BoitierRaw>();
	enum NivBatt {_0,_25,_50,_75,_100};
	
	private class BoitierRaw extends CellTable{
		
		String nomMobile;
		String mid;
		String pictoBoitier;
		String derConnexion;
		String imgBatt;
		
		public BoitierRaw(String nomMobile, String mid, String pictoBoitier, NivBatt nivBatt, String derConnexion) {
			this.nomMobile = nomMobile;
			this.mid = mid;
			this.pictoBoitier = pictoBoitier;
			switch(nivBatt) {
			case _0:					
				imgBatt = "/img/power-0.png";
			case _25:					
				imgBatt = "/img/power-25.png";
			case _50:					
				imgBatt = "/img/power-50.png";
			case _75:					
				imgBatt = "/img/power-75.png";
			case _100:					
				imgBatt = "/img/power-100.png";
		}		
			this.derConnexion = derConnexion;
		}
		
		public String getNomMobile() {
			return nomMobile;
		}

		public String getMid() {
			return mid;
		}

		public String getPictoBoitier() {
			return pictoBoitier;
		}

		public String getDerConnexion() {
			return derConnexion;
		}

		public String getImgBatt() {
			return imgBatt;
		}

	}
	
	@Override
	public void onModuleLoad() {
		
		boitierRaws.add(new BoitierRaw("twig 01", "33612345678", "/img/boat_red.png", NivBatt._0, "02/07/12 15h13m10s"));
		boitierRaws.add(new BoitierRaw("gh1202 01", "33611223344", "/img/boat_green.png", NivBatt._75, "02/07/12 16h43m55s"));
		boitierRaws.add(new BoitierRaw("skywave 01", "33611335577", "/img/box_pink.png", NivBatt._50, "10/07/12 10h34m08s"));
		boitierRaws.add(new BoitierRaw("sonim xp3 01", "33618765432", "/img/train_pink.png", NivBatt._0, "12/07/12 20h23m48s"));
		boitierRaws.add(new BoitierRaw("fm2200 01", "336100110022", "/img/boat_blue.png", NivBatt._25, "20/07/12 07h07m56s"));
		boitierRaws.add(new BoitierRaw("silex 01", "33612345666", "/img/boat_red.png", NivBatt._0, "02/07/12 15h13m10s"));
		boitierRaws.add(new BoitierRaw("ns100 01", "336123455555", "/img/box_blue.png", NivBatt._75, "22/07/12 11h46m39s"));
		boitierRaws.add(new BoitierRaw("ns200 01", "33612344444", "/img/box_yellow.png", NivBatt._100, "24/07/12 08h00m29s"));
		boitierRaws.add(new BoitierRaw("tracker 01", "33612333333", "/img/jetski_green.png", NivBatt._100, "25/07/12 23h12m35s"));
		boitierRaws.add(new BoitierRaw("tomtom 01", "33612222222", "/img/plane_bluelight.png", NivBatt._25, "02/07/12 15h13m10s"));
		boitierRaws.add(new BoitierRaw("twig 02", "33611111111", "/img/boat_red.png", NivBatt._50, "20/07/12 07h07m56s"));
		boitierRaws.add(new BoitierRaw("twig 03", "33612121212", "/img/boat_green.png", NivBatt._0, "22/07/12 11h46m39s"));
		boitierRaws.add(new BoitierRaw("sonim xp3 test", "33613131313", "/img/plane_green.png", NivBatt._25, "10/07/12 10h34m08s"));
		
		FlexTable table = new FlexTable();
		table.add(boitierRaws.get(0));
		table.add(boitierRaws.get(1));
		table.add(boitierRaws.get(2));
		table.add(boitierRaws.get(3));
		table.add(boitierRaws.get(4));
		table.add(boitierRaws.get(5));
		
		ScrollPanel scrollPanelMobiles = new ScrollPanel();
		scrollPanelMobiles.add(table);
		
		 // Create a tab panel with three tabs, each of which displays a different
	    // piece of text.
	    TabPanel tp = new TabPanel();
	    tp.add(, new Image("/img/mobile.png"));
	    tp.add(new HTML("Foo"), "foo");
//	    tp.add(new HTML("Bar"), "bar");
//	    tp.add(new HTML("Baz"), "baz");

	    // Show the 'mobiles' tab initially.
	    tp.selectTab(0);

	    // Add it to the root panel.
	    RootPanel.get().add(tp);
	}

	public static native void checkForNewAlerts() /*-{
	  	var nbAlertsFromMessage  = parseInt(window.opener.document.getElementById("nbAlertsId").value, 10);
		var allAlertsFromMessage  = window.opener.document.getElementById("allAlertsId");
		var clickedBoitierName = window.opener.document.getElementById("clickedBoitierName").value;
		var nbAlerts  = parseInt($("#nbAlertsId").val(), 10);
		var boitierEnAlerteAouvrir = null;
		var pasDeNouvelleAlerteCliquee = "pasDeNouvelleAlerteCliquee";

		if (nbAlerts < nbAlertsFromMessage) {
			for (var i = nbAlerts + 1; i <= nbAlertsFromMessage; i++) {
				start = '#start#' + i + '#';
				indexStart = allAlertsFromMessage.value.indexOf(start, 0);
				$("#indexStartId").val(indexStart);
				
				end = '#end#' + i + '#';
				indexEnd = allAlertsFromMessage.value.indexOf(end, 0);
				$("#indexEndId").val(indexEnd);
				
				var nouvelleAlerte = allAlertsFromMessage.value.substring(indexStart + start.length, indexEnd);
				$("#nouvelleAlerteId").val(nouvelleAlerte);
				
				var id_boitier = parseInt(getBoitierId(nouvelleAlerte), 10);
				$("#boitierId").val(id_boitier);

				var id_alerteType = parseInt(getAlerteTypeId(nouvelleAlerte), 10);
				$("#typeAlerteId").val(id_alerteType);

				var id_severite = parseInt(getSeveriteId(nouvelleAlerte), 10);
				$("#severiteId").val(id_severite);
				
				createAlert(id_boitier, id_alerteType, id_severite);
				}
			$("#nbAlertsId").val(nbAlertsFromMessage);
		} else {
			$("#msgId").val(nbAlerts + ' >=' + nbAlertsFromMessage);
		}
		// alert('clickedBoitierName=' +clickedBoitierName);
		if (clickedBoitierName !="" && clickedBoitierName != pasDeNouvelleAlerteCliquee) {
			boitierEnAlerteAouvrir = getBoitierEnAlerteWhereNameIs(clickedBoitierName);
			ouvrirNouvelOnglet(boitierEnAlerteAouvrir, "visu");
			window.opener.document.getElementById("clickedBoitierName").value = pasDeNouvelleAlerteCliquee; 
			
			// ce if sert a ce que l'onglet ne reprenne pas le focus toutes les sec dans le cas ou il a deja et ouvert.
			//if (!ongletDejaCree(boitierEnAlerteAouvrir)) {
			//	ouvrirNouvelOnglet(boitierEnAlerteAouvrir, "visu");
			//}
		}
		
		setTimeout("checkForNewAlerts()", 1 * 1000);
		
	//
	// nouvelle alerte a la forme "6,0,2"; renvoie 6
	//
	function getBoitierId(nouvelleAlerte) {
		return nouvelleAlerte.substring(0, nouvelleAlerte.indexOf(",", 0));
	}
	
	//
	// nouvelle alerte a la forme "6,0,2"; renvoie 0
	//
	function getAlerteTypeId(nouvelleAlerte) {
		 firstIndexOf = nouvelleAlerte.indexOf(",", 0);
		 return nouvelleAlerte.substring(firstIndexOf + 1, nouvelleAlerte.indexOf(",", firstIndexOf + 1));
	}
	
	//
	// nouvelle alerte a la forme "6,0,2"; renvoie 2
	//
	function getSeveriteId(nouvelleAlerte) {
		 lastIndex = nouvelleAlerte.lastIndexOf(",");
		 return nouvelleAlerte.substring(lastIndex + 1);
	}
	
//		$(document).ready(function() {
//		   	$("#alertTriggerLink").click(function(event){
//					if (triggerAlertPending) {
//						$("#triggerAlertImg").attr("src", "./img/playback-play.png");
//						$("#alertTriggerLink").attr("title", "Lancer le déclenchement automatique d'alertes");
//
//						stopTriggerAlert();
//					} else {
//						$("#triggerAlertImg").attr("src", "./img/playback-pause.png");
//						$("#alertTriggerLink").attr("title", "Stopper le déclenchement automatique d'alertes");
//
//						triggerAlertPending = true;
//						triggerAlert();
//					}
//	   			});
//		   	checkForNewAlerts();
//		});
//		
//		$(function() {
//			$('#onglets').css('display', 'block');
//			$('#onglets').click(function(event) {
//				var actuel = event.target;
//				if (!/li/i.test(actuel.nodeName) || actuel.className.indexOf('actif') > -1) {
//					return;
//				}
//				$(actuel).addClass('actif').siblings().removeClass('actif');
//				setDisplay();
//			});
//			function setDisplay() {
//				var modeAffichage;
//				$('#onglets li').each(function(rang) {
//					modeAffichage = $(this).hasClass('actif') ? '' : 'none';
//					$('.item').eq(rang).css('display', modeAffichage);
//				});
//			}
//			setDisplay();
//		});
		
	}-*/;
	
}